# 配置

本文档详细介绍了 ZBook 系统的各种配置参数。这些配置参数决定了系统的运行方式，包括文档仓库、认证方式、电子邮件设置、数据库连接以及存储配置等。

## 系统参数配置

系统参数配置主要涉及应用的基础设置、WebSocket 和后端服务的 URL、认证服务的配置等。

### 基础配置

以下是系统的基础配置参数:

- **DOC_REPONAME**: 设置首页“文档”按钮跳转的目标仓库名称。用户点击后，将会跳转到指定的 GitHub 仓库中查看文档内容。
- **DOC_USERNAME**: 设置首页“文档”按钮跳转的 GitHub 用户名。与 `DOC_REPONAME` 配合使用，确定文档链接的完整 URL。
- **BEIAN**: 网站的备案号。若设置了备案号，将在首页底部显示，符合中国大陆的法律要求。

```bash
DOC_REPONAME=docs  # 首页中文档按钮跳转的仓库的仓库名
DOC_USERNAME=admin # 首页中文档按钮跳转的仓库的用户名
BEIAN=""           # 备案号，若不为空，则在网站首页footer中显示
```

![doc](./assets/doc.gif)

以下参数配置系统端口信息,若使用服务器，可以将示例中`localhost:ip`换成对应的域名：

- **WEBSOCKET_URL**: 设置 WebSocket 服务的 URL，供前端与 WebSocket 服务器进行实时通信。
- **BACKEND_URL**: 设置后端服务的 URL，前端将通过此 URL 访问后端 API。
- **AUTH_URL**: 设置认证服务的 URL，供系统进行用户认证。
- **AUTH_SECRET**: 用于加密和验证认证令牌的密钥，应设置为一个安全的随机字符串。
- **AUTH_TRUST_HOST**: 设置是否信任当前的主机名，用于认证过程中防止跨站点请求伪造（CSRF）攻击。若设置为 `true`，表示信任当前主机。

```bash
WEBSOCKET_URL=ws://localhost:9099
BACKEND_URL=http://localhost:8080
AUTH_URL=http://localhost:3000
AUTH_SECRET=abcdefghigklmnopgrstuvwxyz
AUTH_TRUST_HOST=true
```

### 认证配置

#### GitHub OAuth

GitHub OAuth 配置允许用户使用 GitHub 账号登录应用。配置参数包括 GitHub OAuth 客户端 ID 和客户端密钥。

```bash
GITHUB_ID=fake-github-id
GITHUB_SECRET=fake-github-secret
```

登录 github.com 账号，选择`Setttings`,然后下拉，选中下面的`Developer settings`,点击新建 Oauth APP，如下图所示配置各种参数。如果是在服务器上，可以将图中`localhost:port`换成自己的域名。

![oauth_github](./assets/oauth_github.gif)

#### Google OAuth

Google OAuth 配置允许用户使用 Google 账号登录应用。配置参数包括 Google OAuth 客户端 ID 和客户端密钥。具体如何配置请参见[这里](https://medium.com/@tony.infisical/guide-to-using-oauth-2-0-to-access-google-apis-dead94d6866d)。

### 电子邮件配置

电子邮件配置用于系统发送邮件通知或验证邮件。配置参数包括邮件发送者的名称、地址、SMTP 服务器地址和认证信息。具体如何配置请参见[这里](https://mailtrap.io/blog/gmail-smtp/)。

```bash
EMAIL_SENDER_NAME=zbook
EMAIL_SENDER_ADDRESS=example@example.com ##邮箱
EMAIL_SENDER_PASSWORD=email-secret ##密码
SMTP_AUTH_ADDR=smtp.qq.com # email 服务器
SMTP_SERVER_ADDR=smtp.qq.com:25 # email 服务器
```

### 数据库配置

数据库配置涉及 PostgreSQL 数据库的连接信息，如数据库名称、用户名、密码等。确保这些信息配置正确，以便应用能够正常连接数据库。

```bash
POSTGRES_USER=root
POSTGRES_PASSWORD=postgres-secret
POSTGRES_DB=zbook
```

### 存储配置

存储配置用于设置 MinIO 或其他存储服务的访问信息。配置参数包括存储服务的用户名、密码和存储桶的设置。

```bash
MINIO_ROOT_USER=root
MINIO_ROOT_PASSWORD=minio-secret
```

## 仓库参数配置

仓库参数配置主要用于设置文档仓库的相关信息。这些参数决定了系统如何与 GitHub 或其他代码托管平台上的文档仓库进行交互。

- 仓库名称：可以自定义，支持中文、英文等字符，不能包含有网址特定含义的字符比如`?&.`，同一用户的仓库名称不能重复。
- 对谁可见：支持多级别的可见范围，比如`公开`是不设权限，`登录`是需要登录可见，`选定用户`,则是选中的用户群可见。
- 侧边栏风格、内容风格设置仓库展示的风格。
- Git URL 是仓库的 git 地址，仅支持 http 方式（不支持 ssh）。
- 仓库简介：给出仓库的描述，即方便访客了解内容，又便于检索。
- GitHub 同步令牌：对于 GitHub 仓库，可以使用 GitHub Action 自动同步。
- 令牌或者密码：对于非公开仓库，需要给予 ZBook 读取的权限。

![demo_repo](./assets/demo_repo.png)

### GiHub 同步

要为 ZBook 仓库 配置 GitHub Actions，可以编写一个 .github/workflows/ 目录下的 YAML 文件来定义自动化 CI/CD 流程。以下是一个 GitHub Actions 配置示例，用于自动同步 ZBook 仓库：

在 ZBook 仓库的根目录下创建一个文件路径 .github/workflows/main.yml，这个文件将包含 GitHub Actions 的配置。

```yaml
name: auto_sync

on:
  push:
    branches:
      - main
jobs:
  auto_sync:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Stage
        run: |
          curl -X POST ${{ secrets.ZBOOK_URI }} \
            -H 'Content-Type: application/json' \
            -d '{
              "repo_name": "${{ secrets.ZBOOK_REPO_NAME }}",
              "username": "${{ secrets.ZBOOK_USERNAME }}",
              "sync_token": "${{ secrets.ZBOOK_SYNC_TOKEN }}"
            }' \
            --max-time 600 # 设置最大超时时间为600秒
```

在 GitHub 仓库的 Secrets 中，需要提前配置以下变量：

- ZBOOK_URI: 目标 API 的 URI,比如`https://****/v1/auto_sync_repo`
- ZBOOK_REPO_NAME: 当前项目的仓库名称。比如`docs`
- ZBOOK_USERNAME: 用户名。比如`admin`
- ZBOOK_SYNC_TOKEN: 用于认证的同步令牌。即创建仓库是提供的同步令牌

通过这个 GitHub Actions 配置，当代码推送到 main 分支时，自动触发同步操作，将代码和相关信息同步到指定的目标系统
